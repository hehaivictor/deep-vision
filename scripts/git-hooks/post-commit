#!/bin/bash
#
# Git post-commit hook - 自动更新 Deep Vision 版本号（自动 amend，不产生额外提交）
#
# 安装方法：
#   ./scripts/install-hooks.sh
#

# 获取脚本所在目录
HOOK_DIR="$(cd "$(dirname "$0")" && pwd)"
PROJECT_ROOT="$(cd "$HOOK_DIR/../.." && pwd)"

# 检查是否在 deep-vision 项目中
if [[ ! -f "$PROJECT_ROOT/web/version.json" ]]; then
    exit 0
fi

# 检查是否有 VERSION_SKIP 环境变量（跳过版本更新）
if [[ -n "$VERSION_SKIP" ]]; then
    echo "[version] 跳过版本更新 (VERSION_SKIP 已设置)"
    exit 0
fi

# 在 rebase/cherry-pick/merge 等历史改写阶段跳过，避免干扰流程
GIT_DIR=$(git rev-parse --git-dir 2>/dev/null)
if [[ -d "$GIT_DIR/rebase-merge" ]] || [[ -d "$GIT_DIR/rebase-apply" ]] || [[ -f "$GIT_DIR/CHERRY_PICK_HEAD" ]] || [[ -f "$GIT_DIR/REVERT_HEAD" ]] || [[ -f "$GIT_DIR/MERGE_HEAD" ]]; then
    echo "[version] 历史改写流程中，跳过版本更新"
    exit 0
fi

# 获取最新的 commit message
COMMIT_MSG=$(git log -1 --pretty=%B)

# 检查是否是版本更新的 commit（避免循环）
if [[ "$COMMIT_MSG" == *"[version]"* ]] || [[ "$COMMIT_MSG" == *"chore(version)"* ]] || [[ "$COMMIT_MSG" =~ ^更新版本号 ]]; then
    exit 0
fi

# 检查是否是 merge commit
if [[ "$COMMIT_MSG" == Merge* ]]; then
    exit 0
fi

# 运行版本管理器
echo "[version] 正在检查版本更新..."
python3 "$PROJECT_ROOT/scripts/version_manager.py" >/tmp/deepvision-version-hook.log 2>&1 || true

# 如果版本文件被更新，自动 amend 到当前 commit
if [[ $(git status --porcelain "$PROJECT_ROOT/web/version.json" 2>/dev/null) ]]; then
    echo "[version] 正在更新 commit..."
    git add "$PROJECT_ROOT/web/version.json"
    # 使用 VERSION_SKIP 避免 hook 循环
    VERSION_SKIP=1 git commit --amend --no-edit >/tmp/deepvision-version-amend.log 2>&1
    echo "[version] 版本更新完成"
fi
